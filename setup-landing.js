#!/usr/bin/env node

// =============================================================================
// NOTARYPRO LANDING PAGE SETUP SCRIPT
// =============================================================================

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

console.log('üöÄ Configurando NotaryPro Landing Page...\n');

// Colores para la consola
const colors = {
    reset: '\x1b[0m',
    bright: '\x1b[1m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
    console.log(`${colors[color]}${message}${colors.reset}`);
}

function logStep(step, message) {
    log(`\n${step} ${message}`, 'cyan');
}

function logSuccess(message) {
    log(`‚úÖ ${message}`, 'green');
}

function logError(message) {
    log(`‚ùå ${message}`, 'red');
}

function logWarning(message) {
    log(`‚ö†Ô∏è ${message}`, 'yellow');
}

function logInfo(message) {
    log(`‚ÑπÔ∏è ${message}`, 'blue');
}

// Verificar dependencias
function checkDependencies() {
    logStep('1Ô∏è‚É£', 'Verificando dependencias...');
    
    const requiredPackages = ['pg', 'bcrypt'];
    const missingPackages = [];
    
    for (const pkg of requiredPackages) {
        try {
            require.resolve(pkg);
            logSuccess(`${pkg} est√° instalado`);
        } catch (error) {
            missingPackages.push(pkg);
            logWarning(`${pkg} no est√° instalado`);
        }
    }
    
    if (missingPackages.length > 0) {
        logInfo('Instalando dependencias faltantes...');
        try {
            execSync(`npm install ${missingPackages.join(' ')}`, { stdio: 'inherit' });
            logSuccess('Dependencias instaladas correctamente');
        } catch (error) {
            logError('Error al instalar dependencias');
            process.exit(1);
        }
    }
}

// Crear archivo .env si no existe
function createEnvFile() {
    logStep('2Ô∏è‚É£', 'Configurando variables de entorno...');
    
    const envPath = path.join(__dirname, '.env');
    const envExamplePath = path.join(__dirname, 'env.example');
    
    if (!fs.existsSync(envPath)) {
        if (fs.existsSync(envExamplePath)) {
            try {
                fs.copyFileSync(envExamplePath, envPath);
                logSuccess('Archivo .env creado desde env.example');
            } catch (error) {
                logError('Error al crear archivo .env');
            }
        } else {
            // Crear .env b√°sico
            const envContent = `# ===========================================
# NOTARYPRO BACKEND - VARIABLES DE ENTORNO
# ===========================================

# CONFIGURACI√ìN DE BASE DE DATOS
DB_USER=postgres
DB_HOST=localhost
DB_NAME=notarypro
DB_PASSWORD=your_secure_password_here
DB_PORT=5432

# CONFIGURACI√ìN JWT
JWT_SECRET=your_super_secret_jwt_key_here_make_it_long_and_random

# CONFIGURACI√ìN DE EMAIL (SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password_here

# CONFIGURACI√ìN DE LA API
API_BASE_URL=http://localhost:3000
NODE_ENV=development

# CONFIGURACI√ìN DE ARCHIVOS
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=52428800

# CONFIGURACI√ìN DE SEGURIDAD
API_KEY=your_api_key_here

# CONFIGURACI√ìN DE LOGS
LOG_LEVEL=info
LOG_FILE=logs/app.log

# CONFIGURACI√ìN DE CORS
CORS_ORIGIN=http://localhost:3000,http://localhost:3001

# CONFIGURACI√ìN DE SESIONES
SESSION_SECRET=your_session_secret_here
SESSION_COOKIE_MAX_AGE=86400000

# CONFIGURACI√ìN DE BASE DE DATOS (ADVANCED)
DB_POOL_MIN=2
DB_POOL_MAX=10
DB_POOL_IDLE_TIMEOUT=30000
DB_POOL_ACQUIRE_TIMEOUT=60000

# CONFIGURACI√ìN DE MONITOREO
ENABLE_HEALTH_CHECKS=true
HEALTH_CHECK_INTERVAL=30000
ENABLE_METRICS=true
METRICS_PORT=9090

# CONFIGURACI√ìN DE DESARROLLO
DEBUG=false
ENABLE_SWAGGER=true
ENABLE_GRAPHIQL=false`;
            
            try {
                fs.writeFileSync(envPath, envContent);
                logSuccess('Archivo .env b√°sico creado');
            } catch (error) {
                logError('Error al crear archivo .env b√°sico');
            }
        }
    } else {
        logInfo('Archivo .env ya existe');
    }
}

// Verificar PostgreSQL
function checkPostgreSQL() {
    logStep('3Ô∏è‚É£', 'Verificando PostgreSQL...');
    
    try {
        const version = execSync('psql --version', { encoding: 'utf8' });
        logSuccess(`PostgreSQL detectado: ${version.trim()}`);
        
        // Verificar si el servicio est√° corriendo
        try {
            execSync('pg_isready', { stdio: 'pipe' });
            logSuccess('Servicio PostgreSQL est√° funcionando');
        } catch (error) {
            logWarning('Servicio PostgreSQL no est√° funcionando');
            logInfo('Inicia PostgreSQL con: sudo systemctl start postgresql');
        }
    } catch (error) {
        logError('PostgreSQL no est√° instalado');
        logInfo('Instala PostgreSQL desde: https://www.postgresql.org/download/');
        process.exit(1);
    }
}

// Crear base de datos
function createDatabase() {
    logStep('4Ô∏è‚É£', 'Creando base de datos...');
    
    try {
        // Intentar crear la base de datos
        execSync('createdb notarypro', { stdio: 'pipe' });
        logSuccess('Base de datos "notarypro" creada');
    } catch (error) {
        try {
            // Verificar si ya existe
            execSync('psql -d notarypro -c "SELECT 1"', { stdio: 'pipe' });
            logInfo('Base de datos "notarypro" ya existe');
        } catch (dbError) {
            logError('No se pudo crear ni conectar a la base de datos');
            logInfo('Verifica que PostgreSQL est√© funcionando y que tengas permisos');
            process.exit(1);
        }
    }
}

// Inicializar base de datos
async function initializeDatabase() {
    logStep('5Ô∏è‚É£', 'Inicializando base de datos...');
    
    try {
        const dbConfig = require('./database-config');
        await dbConfig.initializeTables();
        await dbConfig.createDefaultAdmin();
        logSuccess('Base de datos inicializada correctamente');
    } catch (error) {
        logError(`Error al inicializar base de datos: ${error.message}`);
        process.exit(1);
    }
}

// Crear directorios necesarios
function createDirectories() {
    logStep('6Ô∏è‚É£', 'Creando directorios necesarios...');
    
    const directories = [
        'uploads',
        'logs',
        'temp'
    ];
    
    for (const dir of directories) {
        const dirPath = path.join(__dirname, dir);
        if (!fs.existsSync(dirPath)) {
            try {
                fs.mkdirSync(dirPath, { recursive: true });
                logSuccess(`Directorio ${dir} creado`);
            } catch (error) {
                logError(`Error al crear directorio ${dir}`);
            }
        } else {
            logInfo(`Directorio ${dir} ya existe`);
        }
    }
}

// Verificar archivos HTML
function checkHTMLFiles() {
    logStep('7Ô∏è‚É£', 'Verificando archivos HTML...');
    
    const htmlFiles = [
        'landing-page.html',
        'demo-panel.html',
        'demo-panel-enhanced.html',
        'demo-playground.html',
        'saas-panel.html'
    ];
    
    for (const file of htmlFiles) {
        if (fs.existsSync(file)) {
            logSuccess(`${file} encontrado`);
        } else {
            logWarning(`${file} no encontrado`);
        }
    }
}

// Crear script de inicio
function createStartScript() {
    logStep('8Ô∏è‚É£', 'Creando script de inicio...');
    
    const startScript = `#!/bin/bash
# =============================================================================
# NOTARYPRO START SCRIPT
# =============================================================================

echo "üöÄ Iniciando NotaryPro..."

# Verificar si Node.js est√° instalado
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js no est√° instalado"
    exit 1
fi

# Verificar si PostgreSQL est√° funcionando
if ! pg_isready &> /dev/null; then
    echo "‚ö†Ô∏è PostgreSQL no est√° funcionando. Iniciando..."
    sudo systemctl start postgresql
fi

# Instalar dependencias si es necesario
if [ ! -d "node_modules" ]; then
    echo "üì¶ Instalando dependencias..."
    npm install
fi

# Inicializar base de datos si es necesario
echo "üîß Verificando base de datos..."
node database-config.js

# Iniciar la aplicaci√≥n
echo "üåü Iniciando aplicaci√≥n..."
npm start
`;
    
    try {
        fs.writeFileSync('start-notarypro.sh', startScript);
        fs.chmodSync('start-notarypro.sh', '755');
        logSuccess('Script de inicio creado: start-notarypro.sh');
    } catch (error) {
        logError('Error al crear script de inicio');
    }
}

// Crear README de configuraci√≥n
function createSetupREADME() {
    logStep('9Ô∏è‚É£', 'Creando documentaci√≥n de configuraci√≥n...');
    
    const readmeContent = `# NotaryPro - Configuraci√≥n de Landing Page

## üöÄ Configuraci√≥n R√°pida

### 1. Requisitos Previos
- Node.js 16+ instalado
- PostgreSQL 12+ instalado y funcionando
- NPM o Yarn

### 2. Instalaci√≥n
\`\`\`bash
# Clonar o descargar el proyecto
cd notarypro-backend

# Ejecutar script de configuraci√≥n
node setup-landing.js

# O ejecutar manualmente:
npm install
node database-config.js
\`\`\`

### 3. Configuraci√≥n de Base de Datos
1. Edita el archivo \`.env\` con tus credenciales de PostgreSQL
2. Aseg√∫rate de que PostgreSQL est√© funcionando
3. La base de datos se crear√° autom√°ticamente

### 4. Usuarios por Defecto
- **Admin**: admin@notarypro.cl / admin123
- **Certificador**: certificador@notarypro.cl / cert123
- **Gestor**: gestor@notarypro.cl / gestor123
- **Cliente**: cliente@notarypro.cl / cliente123

### 5. Iniciar la Aplicaci√≥n
\`\`\`bash
# Usar script autom√°tico
./start-notarypro.sh

# O manualmente
npm start
\`\`\`

### 6. Acceder a la Landing Page
- **Landing Page**: http://localhost:3000/landing-page.html
- **API**: http://localhost:3000/api/v1
- **Swagger**: http://localhost:3000/api-docs

## üìÅ Estructura de Archivos
\`\`\`
notarypro-backend/
‚îú‚îÄ‚îÄ landing-page.html          # Landing page principal
‚îú‚îÄ‚îÄ database-config.js         # Configuraci√≥n de BD
‚îú‚îÄ‚îÄ setup-landing.js           # Script de configuraci√≥n
‚îú‚îÄ‚îÄ start-notarypro.sh         # Script de inicio
‚îú‚îÄ‚îÄ .env                       # Variables de entorno
‚îú‚îÄ‚îÄ demo-panel.html            # Panel de demostraci√≥n
‚îú‚îÄ‚îÄ demo-panel-enhanced.html   # Panel mejorado
‚îú‚îÄ‚îÄ demo-playground.html       # Playground de pruebas
‚îú‚îÄ‚îÄ saas-panel.html            # Panel SAAS
‚îî‚îÄ‚îÄ ...                        # Otros m√≥dulos
\`\`\`

## üîß Configuraci√≥n Avanzada

### Variables de Entorno Importantes
- \`DB_*\`: Configuraci√≥n de base de datos
- \`JWT_SECRET\`: Clave secreta para JWT
- \`SMTP_*\`: Configuraci√≥n de email
- \`API_BASE_URL\`: URL base de la API

### Personalizaci√≥n
1. Edita \`landing-page.html\` para cambiar el dise√±o
2. Modifica \`database-config.js\` para esquemas personalizados
3. Ajusta \`.env\` para tu entorno

## üÜò Soluci√≥n de Problemas

### Error de Conexi√≥n a BD
\`\`\`bash
# Verificar PostgreSQL
sudo systemctl status postgresql

# Iniciar si es necesario
sudo systemctl start postgresql

# Verificar conexi√≥n
psql -U postgres -d notarypro
\`\`\`

### Error de Dependencias
\`\`\`bash
# Limpiar e instalar
rm -rf node_modules package-lock.json
npm install
\`\`\`

### Error de Permisos
\`\`\`bash
# Dar permisos de ejecuci√≥n
chmod +x start-notarypro.sh
chmod +x setup-landing.js
\`\`\`

## üìû Soporte
- **Email**: support@notarypro.cl
- **Documentaci√≥n**: https://docs.notarypro.cl
- **Issues**: GitHub Issues del proyecto

---
*NotaryPro Chile - Plataforma de Firma Electr√≥nica*
`;
    
    try {
        fs.writeFileSync('SETUP_README.md', readmeContent);
        logSuccess('README de configuraci√≥n creado: SETUP_README.md');
    } catch (error) {
        logError('Error al crear README de configuraci√≥n');
    }
}

// Funci√≥n principal
async function main() {
    try {
        log('üéØ Iniciando configuraci√≥n de NotaryPro Landing Page...', 'bright');
        
        checkDependencies();
        createEnvFile();
        checkPostgreSQL();
        createDatabase();
        await initializeDatabase();
        createDirectories();
        checkHTMLFiles();
        createStartScript();
        createSetupREADME();
        
        log('\nüéâ ¬°Configuraci√≥n completada exitosamente!', 'bright');
        log('\nüìã Pr√≥ximos pasos:', 'cyan');
        log('1. Edita el archivo .env con tus credenciales', 'yellow');
        log('2. Ejecuta: ./start-notarypro.sh', 'yellow');
        log('3. Accede a: http://localhost:3000/landing-page.html', 'yellow');
        log('\nüìö Lee SETUP_README.md para m√°s detalles', 'blue');
        
    } catch (error) {
        logError(`Error durante la configuraci√≥n: ${error.message}`);
        process.exit(1);
    }
}

// Ejecutar si se llama directamente
if (require.main === module) {
    main();
}

module.exports = {
    checkDependencies,
    createEnvFile,
    checkPostgreSQL,
    createDatabase,
    initializeDatabase,
    createDirectories,
    checkHTMLFiles,
    createStartScript,
    createSetupREADME
};
